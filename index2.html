<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>US Composite Views</title>

    <style>
    html,
    body,

    #mainViewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      aspect-ratio: 16/9;
    }
    .esri-ui-top-left {
      height:60% !important;
      width: 33% !important;
      background-color: rgba(127, 255, 212, 0);
    }
    .esri-ui-bottom-left {
      height: 35% !important;
      width: 38% !important;
      background-color: rgba(165, 42, 42, 0.0);
    }
    .esri-ui-bottom-right {
      height: 50%;
      width: 50%;
      background-color: rgba(127, 255, 212, 0);
    }
    .esri-view-user-storage {
      display: none;
    }
    #toolbarDiv {
        position: absolute;
        top: 15px;
        right: 15px;
        cursor: default;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
    }

    #akViewDiv {
      flex: 4;
      flex-direction: column;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      border-style: solid;
      border-width: 1px;
      border-color: gray;
      
      background-color: rgba(250, 250, 250, 0);
      text-align: left;
    }
    #ak2ViewDiv {
      flex: 1;
      flex-direction: column;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      border-bottom-style: solid;
      border-left-style: solid;
      border-right-style: solid;
      border-width: 1px;
      border-color: gray;
    }
    #islandsViewDiv{
      flex:1;
      flex-direction: column;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #hiViewDiv {
      flex: 1.5; 
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      border-style: solid;
      border-width: 1px;
      border-color: gray;
      background-color: rgba(250, 250, 250, 0);
    }
    #gunmViewDiv {
      flex: 1;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      border-left-style: solid;
      border-top-style: solid;
      border-bottom-style: solid;
      border-width: 1px;
      border-color: gray;
      background-color: rgba(250, 250, 25, 0);
    }
    #asViewDiv {
      flex: 1;
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      border-style: solid;
      border-width: 1px;
      border-color: gray;
      background-color: rgba(250, 25, 250, 0);
    }
    #prViewDiv {
      padding: 0;
      margin: 0;
      left: 70%;
      height: 10%;
      width: 20%;
      border-style: solid !important;
      border-width: 1px !important;
      border-color: grey !important;
      background-color: rgba(250, 250, 250, 0);
    }
    #overViewDiv {
      bottom: 3%;
      left: 70%;
      padding: 0;
      margin: 0;
      width: 10%;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background-color: rgba(25, 250, 250, 0);
      box-shadow: 6px 8px 8px grey;
      z-index: 0;
    }   
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.24/"></script>
    <script type="module" src=https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.esm.js></script>
    <link rel="stylesheet" type="text/css" href=https://js.arcgis.com/calcite-components/1.0.0-beta.95/calcite.css />
    <!-- ECM references for local build -->
<!--  <script type="module">
      import MapView from 'https://js.arcgis.com/4.24/@arcgis/core/views/MapView.js';
      import WebMap from "https://js.arcgis.com/4.24/@arcgis/core/WebMap.js";
      import Map from 'https://js.arcgis.com/4.24/@arcgis/core/Map.js';
      import FeatureLayer from "https://js.arcgis.com/4.24/@arcgis/core/layers/FeatureLayer.js";
      import Legend from "https://js.arcgis.com/4.24/@arcgis/core/widgets/Legend.js";
      import Expand from "https://js.arcgis.com/4.24/@arcgis/core/widgets/Expand.js";
      import WebScene from "https://js.arcgis.com/4.24/@arcgis/core/WebScene.js";
      import FieldInfo from "https://js.arcgis.com/4.24/@arcgis/core/popup/FieldInfo.js";
      import SpatialReference from 'https://js.arcgis.com/4.24/@arcgis/core/geometry/SpatialReference.js';
      import * as reactiveUtils from 'https://js.arcgis.com/4.24/@arcgis/core/core/reactiveUtils.js';
      import SceneView from "https://js.arcgis.com/4.24/@arcgis/core/views/SceneView.js";
      import Graphic from "https://js.arcgis.com/4.24/@arcgis/core/Graphic.js";
      import * as promiseUtils from "https://js.arcgis.com/4.24/@arcgis/core/core/promiseUtils.js";
      import * as projection from "https://js.arcgis.com/4.24/@arcgis/core/geometry/projection.js";
      import Basemap from "https://js.arcgis.com/4.24/@arcgis/core/Basemap.js";
      import Extent from "https://js.arcgis.com/4.24/@arcgis/core/geometry/Extent.js";
      import Point from "https://js.arcgis.com/4.24/@arcgis/core/geometry/Point.js";
      import * as urlUtils from "https://js.arcgis.com/4.24/@arcgis/core/core/urlUtils.js";
      import Measurement from "https://js.arcgis.com/4.24/@arcgis/core/widgets/Measurement.js";
-->
    <!-- AMD Modules -->
    <script>  
    require([
      "esri/views/MapView",
      "esri/WebMap",
      "esri/Map",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/widgets/Expand",
      "esri/WebScene",
      "esri/popup/FieldInfo",
      "esri/geometry/SpatialReference",
      "esri/core/reactiveUtils",
      "esri/views/SceneView",
      "esri/Graphic",
      "esri/core/promiseUtils",
      "esri/geometry/projection",
      "esri/Basemap",
      "esri/geometry/Extent",
      "esri/geometry/Point",
      "esri/core/urlUtils",
      "esri/widgets/Measurement"
    ], (
      MapView,
      WebMap,
      Map,
      FeatureLayer,
      Legend,
      Expand,
      WebScene,
      FieldInfo,
      SpatialReference,
      reactiveUtils,
      SceneView,
      Graphic,
      promiseUtils,
      projection,
      Basemap,
      Extent,
      Point,
      urlUtils,
      Measurement
    ) => {
      // Load the projection engine  
        projection.load().then(function() {
        //Projection parameters              
      {
        // Albers Equal Area Projection for continental US
        var conusSR = new SpatialReference(
          'PROJCS["USA_Contiguous_Albers_Equal_Area_Conic", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Albers"], \
          PARAMETER["False_Easting",0], \
          PARAMETER["False_Northing",0], \
          PARAMETER["central_meridian",-96], \
          PARAMETER["Standard_Parallel_1",29.5], \
          PARAMETER["Standard_Parallel_2",45.5], \
          PARAMETER["latitude_of_origin",37.5], \
          UNIT["Meter",1]]');
        // Albers Equal Area projection for Alaska inset
        var akSR = new SpatialReference(
          'PROJCS["Alaska_Albers_Equal_Area_Conic", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Albers"], \
          PARAMETER["False_Easting",0], \
          PARAMETER["False_Northing",0], \
          PARAMETER["central_meridian",-148], \
          PARAMETER["Standard_Parallel_1",55], \
          PARAMETER["Standard_Parallel_2",65], \
          PARAMETER["latitude_of_origin",50], \
          UNIT["Meter",1]]');
        // Albers Equal Area projection for Hawaii inset
        var hiSR = new SpatialReference(
          'PROJCS["Hawaii_Albers_Equal_Area_Conic", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Albers"], \
          PARAMETER["False_Easting",0], \
          PARAMETER["False_Northing",0], \
          PARAMETER["central_meridian",-157], \
          PARAMETER["Standard_Parallel_1",8], \
          PARAMETER["Standard_Parallel_2",18], \
          PARAMETER["latitude_of_origin",13], \
          UNIT["Meter",1]]');
        // Albers Equal Area Projection for Puerto Rico inset
        var prSR = new SpatialReference(
          'PROJCS["ProjWiz_Custom_Albers", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Albers"], \
          PARAMETER["False_Easting",0], \
          PARAMETER["False_Northing",0], \
          PARAMETER["Central_Meridian",-65.75], \
          PARAMETER["Standard_Parallel_1",17], \
          PARAMETER["Standard_Parallel_2",19], \
          PARAMETER["Latitude_Of_Origin",18], \
          UNIT["Meter",1.0]]');
        // Transverse Cylindrical Equal Area Projection for Guam/Northern Marianas inset
        var gunmSR = new SpatialReference(
          'PROJCS["ProjWiz_Custom_Transverse_Cylindrical_Equal_Area", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0.0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Transverse_Cylindrical_Equal_Area"], \
          PARAMETER["False_Easting",0.0], \
          PARAMETER["False_Northing",0.0], \
          PARAMETER["Central_Meridian",-215], \
          PARAMETER["Scale_Factor",1.0], \
          PARAMETER["Latitude_Of_Origin",0.0], \
          UNIT["Meter",1.0]]');
        // Cylindrical Equal Area Projection for American Samoa inset
        var asSR = new SpatialReference(
          'PROJCS["ProjWiz_Custom_Cylindrical_Equal_Area", \
          GEOGCS["GCS_WGS_1984", \
          DATUM["D_WGS_1984", \
          SPHEROID["WGS_1984",6378137.0,298.257223563]], \
          PRIMEM["Greenwich",0.0], \
          UNIT["Degree",0.0174532925199433]], \
          PROJECTION["Cylindrical_Equal_Area"], \
          PARAMETER["False_Easting",0.0], \
          PARAMETER["False_Northing",0.0], \
          PARAMETER["Central_Meridian",-170.7], \
          PARAMETER["Standard_Parallel_1",7.5], \
          UNIT["Meter",1.0]]');
      }       

        // Get parameters from the url: (1) ?featurelayer= (2) &overview= (3) &enabledviews=GLOBE,CONUS,PR,AK,HI,AS,GU
        // Example <baseurl>?featurelayer=d227d6a4ee3e4d2d87eb9843ee14dd87&overview=67ab7f7c535c4687b6518e6d2343e8a2&views=GLOBE,CONUS,AK,HI,PR
        const { query } = urlUtils.urlToObject(window.location.href);

        // Get the views parameter from the url and convert all characters to upper case
        if (query && query.views != null) {
          var urlViews = query.views.toUpperCase();
          // Create an array from the views url parameter
          var viewsArray = urlViews.split(',');
          console.log("views: ",viewsArray);
          // If "GLOBE" is listed in the views parameter, display the overview map
          var displayGlobe = document.getElementById("overViewDiv");
          if (viewsArray.includes("GLOBE")){
            displayGlobe.style.display = 'flex';
          } else {
            displayGlobe.style.display = 'none';
          };
          // If "PR" or "VI" is listed in the parameter for views, display the inset map for Puerto Rico and the US Virgin Islands
          var displayPR = document.getElementById("prViewDiv");
          if (viewsArray.includes("PR") || viewsArray.includes("VI")){
            displayPR.style.display = 'flex';
          } else {
            displayPR.style.display = 'none';
          };
          // If "AK" is listed in the views parameter, display the inset map for Alaska
          var displayAK = document.getElementById("akViewDiv");
          var displayAK2 = document.getElementById("ak2ViewDiv");
          if (viewsArray.includes("AK")){
            displayAK.style.display = 'flex';
            displayAK2.style.display = 'flex';
          } else {
            displayAK.style.display = 'none';
            displayAK2.style.display = 'none';
          };
          // If "HI" is listed in the views parameter, display the inset map for Hawaii
          var displayHI = document.getElementById("hiViewDiv");
          if (viewsArray.includes("HI")){
            displayHI.style.display = 'flex';
          } else {
            displayHI.style.display = 'none';
          };
          // If "GU" or "AS" or "UM" is listed in the views parameter, display the inset map for Guam, the Northern Marianas Is. and American Samoa
          var displayGU = document.getElementById("gunmViewDiv");
          var displayAS = document.getElementById("asViewDiv");
          if (viewsArray.includes("GU") || viewsArray.includes("AS") || viewsArray.includes("UM")){
            displayGU.style.display = 'flex';
            displayAS.style.display = 'flex';
          } else {
            displayGU.style.display = 'none';
            displayAS.style.display = 'none';
          };
          // If "NONE" is listed in the parameter for views, display only the Continental United States
          if (viewsArray.includes("NONE")){
            displayAK.style.display = 'none';
            displayHI.style.display = 'none';
            displayPR.style.display = 'none';
            displayGlobe.style.display = 'none';
          };
        };

        var defaultLayer = new FeatureLayer({
//          url: "https://mtgis-server.geo.census.gov/arcgis/rest/services/BAS_Viewer/BAS22_Participation/MapServer",
          portalItem: {
            //id:"6ac5e325468c4cb9b905f1728d6fbf0f" // US Federally supported hospital points (includes Palau)
            //id:"df53bb7c871b4e13a59e4310a581a917" // County boundaries from HiFLD
            //id:"49c25e0ce50340e08fcfe51fe6f26d1e" // Covid trends
            //id:"c93f8a9f2a614ff8a31db732636eff9b" // 2022 Zip Codes from Esri Data/Maps 
            //id:"cb1886ff0a9d4156ba4d2fadd7e8a139" // Current wind station data
            //id:"d957997ccee7408287a963600a77f61f" // Current wildfires
            //id:"5e92f2e0930848faa40480bcb4fdc44e" // USA Federal Lands
            //id:"79461a1ec0974301bde274177c7108bd" // Earthquake archive
            id:"dd834ef507244f96baa6b29eab5dd396" // 2019 Population density
//          id: "67ab7f7c535c4687b6518e6d2343e8a2" // Ocean basemap

          }
        });

        var backgroundLayer = new FeatureLayer({
          portalItem:{
            id:"75ea506613f847e48ab0f91e93ac538d" // Admin-0 World Countries
          },
          legendEnabled: false,
          renderer: {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: {
              type: "simple-fill", // autocasts as new SimpleFillSymbol()
              color: [235, 235, 235, 1],
              outline: {
                color: [210, 210, 210, 1],
                width: 0.5
              }
            }
          }
        });

        var usStatesLayer = new FeatureLayer({
          portalItem:{
            id:"1ec2ffa0ebd34e4eac694adb9fa18184" // Admin-1 World Countries
          },
          legendEnabled: false,
          renderer: {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: {
              type: "simple-fill", // autocasts as new SimpleFillSymbol()
              color: [235, 235, 235, 1],
              outline: {
                color: [210, 210, 210, 1],
                width: 0.5
              }
            }
          }
        });

        var oceanLayer = new FeatureLayer({
          portalItem:{
            id:"1f43d235ed7d42899b9e4a7214d913e4"
          },
          legendEnabled: false,
          renderer: {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: {
              type: "simple-fill", // autocasts as new SimpleFillSymbol()
              color: [220, 220, 220, 1],
              outline: {
                color: [150, 150, 150, 0],
                width: 0
              }
            }
          }
        });

      // If no parameters are specified in the url, display the default map
      var layer = defaultLayer;
      
      if (query && query.featurelayer) {
        // Create a Map from the first url parameter for the mainView
        var layer = new FeatureLayer({
          portalItem: {
            id: query.featurelayer
            //id: query.featurelayer
          }
        });
      }
      
      var layerMap = new Map({
         layers: [oceanLayer,backgroundLayer,usStatesLayer,layer]
      });

// use jsapi map constructed with layers or webmap        
      var map = layerMap; //webmap; 

      var mainView = new MapView({
          container: "mainViewDiv",
          map: map,
          popup: {
            highlightEnabled: false,
            dockEnabled: true,
            dockOptions: {
              breakpoint: false,
              buttonEnabled: false,
              position: "top-center"
            }
          },
 /*         scale: 15500000,
          center: {
            x: -97,
            y: 38,
            spatialReference: {
              wkid: 4326
            }
          },*/
          extent: {
            xmin: -145,
            ymin: 32,
            xmax: -78,
            ymax: 45,
            spatialReference: 4326
            },
/*          extent: {
            xmin: -2600000,
            ymin: -1400000,
            xmax: 2500000,
            ymax: 1600000,
            spatialReference: conusSR
            },*/
          spatialReference: conusSR,
          ui: {
            components: ["attribution"]
          }
        });

    const cardLegend = new Expand({
      content: new Legend({
        view: mainView,
        style: "card"
        }),
      view: mainView,
      expanded: false
      })
    mainView.ui.add(cardLegend, "bottom-right");

/*    const measurement = new Measurement({
      view: mainView,
      activeTool: "distance"
    })
    mainView.ui.add(measurement, "top-right");

    // Set-up event handlers for buttons and click events
    const distanceButton = document.getElementById('distance');
    const areaButton = document.getElementById('area');
    const clearButton = document.getElementById('clear');

    distanceButton.addEventListener("click", () => {
          distanceMeasurement();
    });
    areaButton.addEventListener("click", () => {
      areaMeasurement();
    });
    clearButton.addEventListener("click", () => {
      clearMeasurements();
    });
    // Switch between area and distance measurement
    function switchTool() {
      const tool = measurement.activeTool === "distance" ? "area" : "distance";
      measurement.activeTool = tool;
    }
    // Call the appropriate DistanceMeasurement2D or DirectLineMeasurement3D
    function distanceMeasurement() {
      const type = activeView.type;
      measurement.activeTool = type.toUpperCase() === "2D" ? "distance" : "direct-line";
      distanceButton.classList.add("active");
      areaButton.classList.remove("active");
    }

    // Call the appropriate AreaMeasurement2D or AreaMeasurement3D
    function areaMeasurement() {
      measurement.activeTool = "area";
      distanceButton.classList.remove("active");
      areaButton.classList.add("active");
    }

    // Clears all measurements
    function clearMeasurements() {
      distanceButton.classList.remove("active");
      areaButton.classList.remove("active");
      measurement.clear();
    } */

    var akView = new MapView({
          container: "akViewDiv",
          map: map,
          center: {
            x: -148,
            y: 63,
            spatialReference: {
              wkid: 4326
            }
          },
/*          extent: {
            xmin: -2600000,
            ymin: 500000,
            xmax: 1200000,
            ymax: 4000000,
            spatialReference: akSR
          },*/
          spatialReference: akSR,
            ui: {
              components: []
            }
          });
        mainView.ui.add("akViewDiv", "top-left");

        var ak2View = new MapView({
          container: "ak2ViewDiv",
          map: map,
          center: {
            x: -168,
            y: 55,
            spatialReference: {
              wkid: 4326
            }
          },
/*          extent: {
            xmin: -2600000,
            ymin: 500000,
            xmax: 1200000,
            ymax: 4000000,
            spatialReference: akSR
          },*/
          spatialReference: akSR,
            ui: {
              components: []
            }
          });
        mainView.ui.add("ak2ViewDiv", "top-left");

/*        var islandsView = new MapView({
            container:"islandsViewDiv",
            ui: {
                components: []
            }
        });
        mainView.ui.add("islandsViewDiv","bottom-left"); */

        var gunmView = new MapView({
        container: "gunmViewDiv",
        map: map,
        center: {
          x: 145.5,
          y: 17,
          spatialReference: {
            wkid: 4326
          }
        },
/*        extent: {
          xmin: -150000,
          ymin: 1395000,
          xmax: 250000,
          ymax: 2300000,
          spatialReference: gunmSR
        },*/
        spatialReference: gunmSR,
        ui: {
          components: []
        }
      });
        mainView.ui.add("gunmViewDiv","bottom-left");

        var asView = new MapView({
        container: "asViewDiv",
        map: map,
        center: {
          x: -170,
          y: -14.3,
          spatialReference: {
            wkid: 4326
          }
        },
        spatialReference: asSR,
        ui: {
          components: []
        }
      });
        mainView.ui.add("asViewDiv","bottom-left");

      var hiIslandsView = new MapView({
        container: "hiViewDiv",
        map: map,
        center: {
          x:-159,
          y:21,
          spatialReference: {
            wkid: 4326
          }
        },
        spatialReference: hiSR,
          ui: {
            components: []
          }
        });

        var hiAloneView = new MapView({
        container: "hiViewDiv",
        map: map,
        center: {
          x:-166.5, // -159,
          y:24, // 21,
          spatialReference: {
            wkid: 4326
          }
        },
        spatialReference: hiSR,
          ui: {
            components: []
          }
        });

      var hiView = hiAloneView;  
      if (viewsArray.includes("HI") && viewsArray.includes("AS")){
        hiView = hiIslandsView;
      };
      mainView.ui.add("hiViewDiv", "bottom-left");

      var prView = new MapView({
        container: "prViewDiv",
        map: map,
        center: {
          x: -66.25,
          y: 18.15,
          spatialReference: {
            wkid: 4326
          }
        },
/*        extent: {
          xmin: -190000,
          ymin: 9500,
          xmax: 150000,
          ymax: 53500,
          spatialReference: prSR
        },*/
        spatialReference: prSR,
        ui: {
          components: []
        }
      });
      mainView.ui.add("prViewDiv","bottom-right");

      // Transform center point of mapView because SceneViewer
      // can only deal with WGS84 or WebMercator in global mode
      const overviewSpatialReference = new SpatialReference({
          wkid: 3857 //WebMercator
        });
      
      let transformCenter = projection.project(mainView.extent.center,overviewSpatialReference);
      
      // Create a default map for the overview
      const defaultOverview = new Map({
          basemap: "gray-vector",
          ground: "world-elevation"
      });
      // If a url parameter is defined, use that id to create a map for the overview
      let overviewMap = defaultOverview;
      if (query && query.overview){
        overviewMap = new WebMap({
          portalItem: {
            id: query.overview
          }
        })        
      }

      // Create an overview globe
      var overView = new SceneView({
        container: "overViewDiv",
        map: overviewMap,
        viewingMode: "global",
            alphaCompositingEnabled: true,  
            environment:{
                background: {
                  type: "color",
                  color: [0, 0, 255, 0]
                },
                lighting: {
//                  type: "virtual",
                  type: "sun",
                  date: new Date("July 20, 2022 20:30:00 UTC")
              },
                atmosphereEnabled: false,
                starsEnabled:false
              },
            camera: {
              position: {
                spatialReference: overviewSpatialReference,
                x:-14500000,
                y:6000000,
                z: 12000000
              },
              heading: 0,
              tilt: 0
            }
      });
      // Remove the default scene widgets
      overView.ui.components = [];
      // Add the overView div
      mainView.ui.add("overViewDiv");
      // disable all navigation in the overView
      overView.when(disableNavigation)

        mainView
          .when(maintainFixedExtent)
          .then(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);
        akView
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);
        ak2View
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);  
        hiView
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);
        gunmView
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);
        asView
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);
        prView
          .when(disableNavigation)
          .then(disablePopupOnClick)
          .then(enableHighlightOnPointerMove);        

        function maintainFixedExtent(view) {
          var fixedExtent = view.extent.clone();
          // keep a fixed extent in the view
          // when the view size changes
          view.on("resize", function() {
            view.extent = fixedExtent;
          });
          return view;
          }
/*
        mainView.watch("widthBreakpoint", function(breakpoint) {
          switch (breakpoint) {
            case "xsmall":
              updateView(true);
              break;
            case "small":
            case "medium":
            case "large":
            case "xlarge":
              updateView(false);
              break;
            default:
           }
        });
                function updateView(isMobile) {
          setTitleMobile(isMobile);
          setLegendMobile(isMobile);
        }

        function setTitleMobile(isMobile) {
          if (isMobile) {
            document.querySelector("#titleDiv").classList.add("invisible");
            view.padding = {
              top: 0
            };
          } else {
            document.querySelector("#titleDiv").classList.remove("invisible");
            view.padding = {
              top: 55
            };
          }
        }

        function setLegendMobile(isMobile) {
          var toAdd = isMobile ? expandLegend : legend;
          var toRemove = isMobile ? legend : expandLegend;

          view.ui.remove(toRemove);
          view.ui.add(toAdd, "bottom-right");
        }
 */       

        // Set highlighting rules and mouse-over popup behavior
        let highlight = null;
        let lastHighlight = null;

        function enableHighlightOnPointerMove(view) {
          view.whenLayerView(layer).then(function(layerView) {
            view.on("pointer-move", function(event) {
              view.hitTest(event).then(function(response) {

                lastHighlight = highlight;

                // if a feature is returned, highlight it
                // and display its attributes in the popup
                // if no features are returned, then close the popup
                var id = null;

                if (response.results.length) {
                  var feature = response.results.filter(function(result) {
                    return result.graphic.layer === layer;
                  })[0].graphic;

                  feature.popupTemplate = layer.popupTemplate;
                  id = feature.attributes.OBJECTID;
                  highlight = layerView.highlight([id]);
                  var selectionId = mainView.popup.selectedFeature
                    ? mainView.popup.selectedFeature.attributes.OBJECTID
                    : null;

                  if (highlight && id !== selectionId) {
                    mainView.popup.open({
                      features: [feature]
                    });
                  }
                } else {
                  if (mainView.popup.visible) {
                    mainView.popup.close();
                    mainView.popup.clear();
                  }
                }

                // remove the previous highlight
                if (lastHighlight) {
                  lastHighlight.remove();
                  lastHighlight = null;
                }
              });
            });
          });

//set inset maps to have same scale as main map (except for Alaska)
      akView.scale = mainView.scale; //  * 2.8571
      ak2View.scale = mainView.scale;
      hiView.scale = mainView.scale;
      prView.scale = mainView.scale;  
      gunmView.scale = mainView.scale;
      asView.scale = mainView.scale;
          }
//remove zoom widget from popup
      mainView.popup.viewModel.includeDefaultActions = false;

        // disables all navigation in the view
        function disableNavigation(view) {
          view.popup.dockEnabled = true;
          // Removes the zoom action on the popup
          view.popup.actions = [];
          // stops propagation of default behavior when an event fires
          function stopEvtPropagation(event) {
            event.stopPropagation();
          }
          // disable mouse wheel scroll zooming on the view
          view.navigation.mouseWheelZoomEnabled = false;
          // disable zooming via double-click on the view
          view.on("double-click", stopEvtPropagation);
          // disable zooming out via double-click + Control on the view
          view.on("double-click", ["Control"], stopEvtPropagation);
          // disables pinch-zoom and panning on the view
          view.navigation.browserTouchPanEnabled = false;
          view.on("drag", stopEvtPropagation);
          // disable the view's zoom box to prevent the Shift + drag
          // and Shift + Control + drag zoom gestures.
          view.on("drag", ["Shift"], stopEvtPropagation);
          view.on("drag", ["Shift", "Control"], stopEvtPropagation);
          // prevents zooming and rotation with the indicated keys
          view.on("key-down", function(event) {
            var prohibitedKeys = ["+", "-", "_", "=", "a", "d"];
            var keyPressed = event.key.toLowerCase();
            if (prohibitedKeys.indexOf(keyPressed) !== -1) {
              event.stopPropagation();
            }
          });
          return view;
        }
        // prevents the user from opening the popup with click
        function disablePopupOnClick(view) {
          view.on("click", function(event) {
            event.stopPropagation();
          });
          return view;
        }

        // draw the main map extent on the overview globe
        overView.when(() => {
          mainView.when(() => {
            drawExtent();
          });
        });
        
/*        const extentDebouncer = promiseUtils.debounce(() => {
          //sync the overview Scene center when the main map moves
//          if (mainView.center != NULL){
            transformCenter = projection.project(mainView.center,overviewSpatialReference);
            overView.goTo({
                position: {
                  spatialReference: overviewSpatialReference,
                  x:transformCenter.x,
                  y:transformCenter.y,
                  z:12000000,
                }, 
            });
//          }  
        });*/
        const transformMainExtent = projection.project(mainView.extent,overviewSpatialReference);
        console.log("asCenterX: ",asView.center.x,"asCenterY: ",asView.center.y);
//        const transformPRExtent = projection.project(akView.extent,overviewSpatialReference);
                
        function drawExtent() {
          const extent3Dgraphic = new Graphic({
            geometry: transformMainExtent,
            symbol: {
              type: "simple-fill",
              color: [0, 0, 0, 0],
              outline:  {
                width: 1,
                color: [255, 0, 0, 1]
              }
            }
          });
          overView.graphics.add(extent3Dgraphic);
          
/*          reactiveUtils.watch(
            () => mainView.extent,
              // Sync the overview map 
              // whenever the main view moves
               (extent) => {
                //transform the mainView extent into something that SceneViewer can handle
//                if (mainView.center != NULL) {
                  const transformExtent = projection.project(extent,overviewSpatialReference);
                    extentDebouncer().then(() => {
                      extent3Dgraphic.geometry = transformExtent;
                    });
//                  }
                console.log("mainViewCenterX: ",mainView.center.x,"mainViewCenterY: ",mainView.center.y);
                console.log("transformCenterX: ",transformCenter.x,"transformCenterY: ",transformCenter.y);
                console.log("overViewCenterX: ",overView.center.x,"overViewCenterY: ",overView.center.y);
                  },
                  {
                  initial: true
                  }
          );*/
        }
    
console.log("size :",mainView.size[0]/mainView.size[1]);    
      });
    })
     </script>
  </head>

  <body>
    <div id="mainViewDiv"></div>
<!--    <div id="leftInsetDiv" class="esri-widget"></div>
    <div id="islandsViewDiv" class="esri-widget"></div>
    <div id="islandsViewDiv" class="esri-widget"></div> -->
    <div id="asViewDiv" class="esri-widget"></div>
    <div id="gunmViewDiv" class="esri-widget"></div>
    <div id="akViewDiv" class="esri-widget"><div id="divLabel"><h1 style="font-size:1vw;">Alaska</h1></div></div>
    <div id="ak2ViewDiv" class="esri-widget"></div>
    <div id="hiViewDiv" class="esri-widget"><h1 style="font-size:1vw;">Hawaii</h1></div></div>
    <div id="prViewDiv" class="esri-widget"><h1 style="font-size:1vw;">Puerto Rico</h1></div>
    <div id="overViewDiv"></div>
<!--    <div id="toolbarDiv" class="esri-component esri-widget"> 
      <button id="distance" class="esri-widget--button esri-interactive esri-icon-measure-line" title="Distance Measurement Tool"></button>
      <button id="area" class="esri-widget--button esri-interactive esri-icon-measure-area" title="Area Measurement Tool"></button>
      <button id="clear" class="esri-widget--button esri-interactive esri-icon-trash" title="Clear Measurements"></button>
    </div> -->
  </body>
</html>